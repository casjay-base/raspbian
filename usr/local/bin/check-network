#!/usr/bin/env bash

APPNAME="check-network"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
PATH="/usr/games:$PATH"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# @Author      : Jason
# @Contact     : jason@casjaysdev.com
# @File        : check-network
# @Created     : Mon, Dec 31, 2019, 00:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Check if the internet is up
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

HOST=$(hostname -f)
HOSTNAME=$(hostname -f)
HOSTSHORT=$(hostname -s)
IFISONLINE=$(
  timeout 0.2 ping -c1 8.8.8.8 &>/dev/null
  echo $?
)
IFISLOCAL=$(
  timeout 0.2 ping -c1 10.0.0.1 &>/dev/null
  echo $?
)
NETDEV="$(ip route | grep default | sed -e "s/^.*dev.//" -e "s/.proto.*//")"
CURRIP4="$(/sbin/ifconfig $NETDEV | grep -E "venet|inet" | grep -v "127.0.0." | grep 'inet' | grep -v inet6 | awk '{print $2}' | sed 's#addr:##g' | head -n1)"

if [ "$NETDEV" == "wlan*" ]; then
  ip addr flush $NETDEV
  ifdown $NETDEV && ifup $NETDEV
fi

if [ "$IFISONLINE" -ne "0" ]; then
  exit 1
else
  curl -LSs https://github.com/casjay-base/rasbian/raw/master/etc/issue > /etc/issue
  curl -LSs https://github.com/casjay-base/raspbian/raw/master/etc/casjaysdev/messages/legal.txt > /etc/casjaysdev/messages/legal.txt
  echo "" >>/etc/issue
  echo "" >/etc/motd
  fortune | cowsay >>/etc/motd
  echo "" >>/etc/motd
  find /etc/issue* /etc/motd* -type f -exec sed -i "s#MYHOSTIP#$CURRIP4#g" {} \;
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

exit $?
